<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hospital Regional Villa</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .login-bg {
            position: relative;
            min-height: 100vh;
            background: linear-gradient(to right, #f3f4f6 0%, #dbeafe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-bg-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 900px;
            opacity: 0.1;
            background-image: url('./public/image.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 1;
        }
        
        .login-bg > *:not(.login-bg-image) {
            position: relative;
            z-index: 2;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .input-field {
            padding-left: 42px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading .btn-text {
            visibility: hidden;
        }

        .btn-loading .btn-spinner {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
        }

        .toggle-password:hover {
            color: #6b7280;
        }
    </style>
</head>
<body class="login-bg flex items-center justify-center p-4">
    <!-- Background Image -->
    <div class="login-bg-image"></div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <div class="login-card rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
        <!-- Logo e Título -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4 pulse-icon">
                <img src="./public/image.png" alt="Logo Hospital" class="w-12 h-12">
            </div>
            <h1 class="text-3xl font-bold text-gray-800">Hospital Regional Villa</h1>
            <p class="text-gray-500 mt-2">Sistema de Gestão Hospitalar</p>
        </div>

        <!-- Formulário de Login -->
        <form id="loginForm" class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ID do Usuário</label>
                <div class="relative">
                    <i class="fas fa-id-badge input-icon"></i>
                    <input 
                        type="text" 
                        id="usuarioId" 
                        required
                        class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                        placeholder="Digite seu ID de usuário"
                        autocomplete="off"
                    >
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                <div class="relative">
                    <i class="fas fa-lock input-icon"></i>
                    <input 
                        type="password" 
                        id="senha" 
                        required
                        class="input-field w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                        placeholder="Digite sua senha"
                        autocomplete="current-password"
                    >
                    <button type="button" class="toggle-password" onclick="togglePassword()">
                        <i class="fas fa-eye" id="toggleIcon"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <label class="flex items-center">
                    <input type="checkbox" id="lembrar" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <span class="ml-2 text-sm text-gray-600">Lembrar-me</span>
                </label>
                
            </div>

            <button 
                type="submit" 
                id="btnLogin"
                class="relative w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold text-lg shadow-lg hover:shadow-xl"
            >
                <span class="btn-text flex items-center justify-center">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Entrar
                </span>
                <span class="btn-spinner hidden">
                    <i class="fas fa-spinner fa-spin text-xl"></i>
                </span>
            </button>
        </form>

        <!-- Divisor -->
        <div class="relative my-6">
            <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-200"></div>
            </div>
            <div class="relative flex justify-center">
                <span class="bg-white px-4 text-sm text-gray-500">ou</span>
            </div>
        </div>

        <!-- Link para registro -->
        <p class="text-center text-gray-600">
            Não tem uma conta? 
            <a href="#" onclick="abrirModalRegistro()" class="text-blue-600 hover:text-blue-700 font-medium">
                Solicitar acesso
            </a>
        </p>

        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-gray-200 text-center">
            <p class="text-xs text-gray-400">
                © 2026 Hospital Regional Villa. Todos os direitos reservados.
            </p>
        </div>
    </div>

    <!-- Modal Esqueci Senha -->
    <div id="modalEsqueciSenha" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-4">
                    <i class="fas fa-key text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">Recuperar Senha</h3>
                <p class="text-gray-500 mt-2">Digite seu e-mail para receber o link de recuperação</p>
            </div>
            <form id="formEsqueciSenha">
                <div class="mb-4">
                    <div class="relative">
                        <i class="fas fa-id-badge input-icon"></i>
                        <input 
                            type="text" 
                            id="usuarioIdRecuperacao" 
                            required
                            class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Digite seu ID de usuário"
                        >
                    </div>
                </div>
                <div class="flex gap-3">
                    <button 
                        type="button" 
                        onclick="fecharEsqueciSenha()"
                        class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
                    >
                        <i class="fas fa-paper-plane mr-2"></i>Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Criar Conta (Solicitar Acesso) -->
    <div id="modalRegistro" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Solicitar Acesso</h3>
                <button type="button" onclick="fecharModalRegistro()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>

            <p class="text-gray-600 mb-6 text-sm">
                Preencha os dados abaixo para solicitar uma conta. Um administrador analisará sua solicitação.
            </p>

            <form id="formRegistro" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ID de Usuário</label>
                    <div class="relative">
                        <i class="fas fa-id-badge input-icon"></i>
                        <input 
                            type="text" 
                            id="registroId" 
                            required
                            class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Ex: 2025"
                        >
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <div class="relative">
                        <i class="fas fa-user input-icon"></i>
                        <input 
                            type="text" 
                            id="registroNome" 
                            required
                            class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Digite seu nome completo"
                        >
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <div class="relative">
                        <i class="fas fa-lock input-icon"></i>
                        <input 
                            type="password" 
                            id="registroSenha" 
                            required
                            class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Digite uma senha"
                        >
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                    <div class="relative">
                        <i class="fas fa-lock input-icon"></i>
                        <input 
                            type="password" 
                            id="registroConfirmSenha" 
                            required
                            class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Confirme sua senha"
                        >
                    </div>
                </div>

                <button 
                    type="submit" 
                    class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold text-lg shadow-lg hover:shadow-xl"
                >
                    <i class="fas fa-paper-plane mr-2"></i>Solicitar Acesso
                </button>

                <p class="text-center text-sm text-gray-600">
                    Já tem uma conta? 
                    <a href="#" onclick="fecharModalRegistro()" class="text-blue-600 hover:text-blue-700 font-medium">
                        Voltar ao login
                    </a>
                </p>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, database } from './config/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { ref, get, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Verificar se já está logado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário já está logado, redirecionar para o sistema
                window.location.href = '/index.html';
            }
        });

        // Função para debugar - verificar se consegue ler do Firebase
        window.testarConexaoFirebase = async function() {
            try {
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, 'usuarios'));
                
                if (snapshot.exists()) {
                    const usuarios = snapshot.val();
                    alert('✅ Firebase OK! Usuários: ' + Object.keys(usuarios).join(', '));
                } else {
                    alert('❌ Nenhum usuário encontrado no Firebase. Verifique a importação!');
                }
            } catch (error) {
                alert('❌ Erro ao conectar no Firebase:\n' + error.message);
            }
        };

        // Adicionar botão de teste no formulário
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            const testBtn = document.createElement('button');
            testBtn.type = 'button';
            testBtn.onclick = testarConexaoFirebase;
            form.appendChild(testBtn);
        });

        // Função para fazer login com ID
        window.fazerLoginComId = async function(usuarioId, senha) {
            try {
                // Buscar usuário pelo ID no banco de dados
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, `usuarios/${usuarioId}`));
                
                if (!snapshot.exists()) {
                    // Tentar listar todos os usuários disponíveis
                    const allSnapshot = await get(child(dbRef, 'usuarios'));
                    if (allSnapshot.exists()) {
                        const usuariosDisponiveis = Object.keys(allSnapshot.val());
                        throw new Error(`Usuário "${usuarioId}" não encontrado. Disponíveis: ${usuariosDisponiveis.join(', ')}`);
                    } else {
                        throw new Error('Nenhum usuário configurado no Firebase! Importe os usuários primeiro.');
                    }
                }
                
                const usuario = snapshot.val();
                
                // Verificar se o usuário está ativo
                if (usuario.ativo === false) {
                    throw new Error('Usuário inativado. Entre em contato com o administrador do sistema');
                }
                
                // Verificar senha (em produção, isso deve ser criptografado)
                if (usuario.senha !== senha) {
                    throw new Error('Senha incorreta');
                }
                
                // Simular login
                localStorage.setItem('usuarioLogado', usuarioId);
                localStorage.setItem('usuarioEmail', usuario.email || '');
                localStorage.setItem('usuarioNome', usuario.nome || usuarioId);
                
                return { uid: usuarioId, email: usuario.email };
            } catch (error) {
                throw error;
            }
        };

        // Função para solicitar recuperação de senha
        window.solicitarRecuperacaoSenha = async function(usuarioId) {
            try {
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, `usuarios/${usuarioId}`));
                
                if (!snapshot.exists()) {
                    throw new Error('Usuário não encontrado');
                }
                
                // Aqui você pode adicionar lógica para enviar email ou notificação
                // Por enquanto, apenas simula
                throw new Error('Entre em contato com o administrador do sistema');
            } catch (error) {
                throw error;
            }
        };

        // Toggle password visibility
        window.togglePassword = function() {
            const senhaInput = document.getElementById('senha');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (senhaInput.type === 'password') {
                senhaInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                senhaInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        };

        // Toast notification
        window.mostrarToast = function(mensagem, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `<i class="fas ${tipo === 'success' ? 'fa-check-circle' : tipo === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>${mensagem}`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // Modal esqueci senha
        window.abrirEsqueciSenha = function() {
            document.getElementById('modalEsqueciSenha').classList.remove('hidden');
        };

        window.fecharEsqueciSenha = function() {
            document.getElementById('modalEsqueciSenha').classList.add('hidden');
            document.getElementById('usuarioIdRecuperacao').value = '';
        };

        // Modal criar conta
        window.abrirModalRegistro = function() {
            document.getElementById('modalRegistro').classList.remove('hidden');
        };

        window.fecharModalRegistro = function() {
            document.getElementById('modalRegistro').classList.add('hidden');
            document.getElementById('formRegistro').reset();
        };

        // Form esqueci senha
        document.getElementById('formEsqueciSenha').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usuarioId = document.getElementById('usuarioIdRecuperacao').value.trim();
            
            try {
                await solicitarRecuperacaoSenha(usuarioId);
                mostrarToast('Instruções de recuperação enviadas para o administrador!', 'success');
                fecharEsqueciSenha();
            } catch (error) {
                mostrarToast(error.message || 'Erro ao recuperar senha', 'error');
            }
        });

        // Form criar conta (solicitar acesso)
        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuarioId = document.getElementById('registroId').value.trim();
            const nome = document.getElementById('registroNome').value.trim();
            const senha = document.getElementById('registroSenha').value;
            const confirmSenha = document.getElementById('registroConfirmSenha').value;
            
            // Validações
            if (!usuarioId || !nome || !senha || !confirmSenha) {
                mostrarToast('Preencha todos os campos', 'error');
                return;
            }
            
            if (senha !== confirmSenha) {
                mostrarToast('As senhas não conferem', 'error');
                return;
            }
            
            if (senha.length < 6) {
                mostrarToast('A senha deve ter no mínimo 6 caracteres', 'error');
                return;
            }
            
            try {
                // Verificar se o ID já existe em usuários
                const dbRef = ref(database);
                const snapshotUsuario = await get(child(dbRef, `usuarios/${usuarioId}`));
                
                if (snapshotUsuario.exists()) {
                    mostrarToast('Este ID de usuário já existe', 'error');
                    return;
                }
                
                // Verificar se já tem solicitação pendente
                const snapshotSolicitacao = await get(child(dbRef, `solicitacoes_cadastro/${usuarioId}`));
                
                if (snapshotSolicitacao.exists()) {
                    mostrarToast('Você já tem uma solicitação pendente', 'info');
                    return;
                }
                
                // Criar solicitação de cadastro pendente
                const { set } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                
                const solicitacaoCadastro = {
                    id: usuarioId,
                    nome: nome,
                    senha: senha,
                    dataSolicitacao: new Date().toLocaleString('pt-BR'),
                    status: 'pendente'
                };
                
                // Salvar solicitação em "solicitacoes_cadastro"
                await set(child(dbRef, `solicitacoes_cadastro/${usuarioId}`), solicitacaoCadastro);
                
                mostrarToast('Solicitação enviada! Um administrador irá analisá-la.', 'success');
                fecharModalRegistro();
                
            } catch (error) {
                mostrarToast(error.message || 'Erro ao solicitar cadastro', 'error');
            }
        });

        // Form login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuarioId = document.getElementById('usuarioId').value.trim();
            const senha = document.getElementById('senha').value;
            const lembrar = document.getElementById('lembrar').checked;
            const btnLogin = document.getElementById('btnLogin');
            
            // Validar entrada
            if (!usuarioId || !senha) {
                mostrarToast('Preencha todos os campos', 'error');
                return;
            }
            
            // Ativar loading
            btnLogin.classList.add('btn-loading');
            btnLogin.querySelector('.btn-spinner').classList.remove('hidden');
            
            try {
                const user = await fazerLoginComId(usuarioId, senha);
                
                if (user) {
                    // Salvar preferência de lembrar
                    if (lembrar) {
                        localStorage.setItem('rememberUser', usuarioId);
                    } else {
                        localStorage.removeItem('rememberUser');
                    }
                    
                    mostrarToast('Login realizado com sucesso!', 'success');
                    
                    // Redirecionar para o sistema
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 1000);
                } else {
                    mostrarToast('ID ou senha incorretos', 'error');
                }
            } catch (error) {
                mostrarToast(error.message || 'ID ou senha incorretos', 'error');
            } finally {
                // Desativar loading
                btnLogin.classList.remove('btn-loading');
                btnLogin.querySelector('.btn-spinner').classList.add('hidden');
            }
        });

        // Carregar ID salvo
        const savedId = localStorage.getItem('rememberUser');
        if (savedId) {
            document.getElementById('usuarioId').value = savedId;
            document.getElementById('lembrar').checked = true;
        }
    </script>
</body>
</html>
